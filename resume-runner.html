<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Resume Runner Ninja</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #1a202c;
            font-family: system-ui, -apple-system, sans-serif;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }
        canvas {
            display: block;
            touch-action: none;
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            color: white;
            padding: env(safe-area-inset-top) 15px 15px;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d3748;
            padding: 1.5rem;
            border-radius: 1rem;
            border: 4px solid #4a5568;
            max-width: 90%;
            width: 400px;
            display: none;
            pointer-events: auto;
            z-index: 100;
        }
        .btn-option {
            width: 100%;
            padding: 14px;
            margin: 6px 0;
            background: #4a5568;
            border: 2px solid transparent;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            text-align: left;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s;
        }
        .btn-option.correct { background: #38a169 !important; border-color: #2f855a; }
        .btn-option.wrong { background: #e53e3e !important; border-color: #c53030; }
        
        .touch-controls {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 20px);
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 30px 20px;
            pointer-events: none;
            z-index: 50;
        }
        .t-btn {
            width: 75px;
            height: 75px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            pointer-events: auto;
            backdrop-filter: blur(8px);
            color: white;
            -webkit-tap-highlight-color: transparent;
        }
        .t-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.9); }

        .stats-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.8rem;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 4px 0;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="flex justify-between items-start">
        <div class="z-10 bg-black/40 p-2 rounded-lg">
            <div class="text-sm font-bold text-blue-400">Day <span id="game-day">1</span>: <span id="delivered-count">0</span>/5</div>
            <div class="w-24 h-2 bg-gray-800 rounded-full mt-1 overflow-hidden">
                <div id="energy-bar" class="h-full bg-yellow-400" style="width: 100%"></div>
            </div>
        </div>
        <div class="bg-black/40 p-2 rounded-lg text-center min-w-[80px]">
            <div class="text-[10px] uppercase font-bold text-blue-300">Points</div>
            <div id="total-points" class="text-xl font-bold">0</div>
        </div>
        <div id="status-msg" class="text-[10px] bg-black/40 p-2 rounded-lg uppercase font-bold text-white max-w-[80px]">Go to Station!</div>
    </div>
</div>

<div id="quiz-modal" class="modal">
    <div class="flex justify-between items-center mb-2">
        <span class="text-xs font-bold text-blue-300 uppercase">Question <span id="q-num">1</span>/5</span>
        <span class="text-xs font-bold text-green-400">Score: <span id="q-score">0</span></span>
    </div>
    <h2 class="text-lg font-bold mb-3 text-white leading-tight" id="quiz-question"></h2>
    <div id="quiz-options"></div>
    <div id="quiz-feedback" class="mt-3 p-3 rounded-lg text-sm font-medium hidden"></div>
    <button id="next-q-btn" class="hidden w-full mt-4 bg-blue-600 p-3 rounded-xl font-bold">NEXT</button>
</div>

<div id="msg-modal" class="modal" style="display: block;">
    <h1 id="msg-title" class="text-2xl font-bold mb-2 text-center text-blue-400">RESUME RUNNER</h1>
    
    <div id="global-stats" class="stats-panel">
        <div class="flex justify-between mb-2 border-b border-white/20 pb-1">
            <span class="text-blue-300 font-bold uppercase text-[10px]">Top 3 Scores</span>
            <span class="text-white text-[10px]">Players: <span id="stat-total-players">...</span></span>
        </div>
        <div id="leaderboard-list">
            <div class="text-center text-gray-400 py-2">Loading scores...</div>
        </div>
    </div>

    <p id="msg-body" class="mb-6 text-center text-gray-300 text-sm">Write resumes at the computer station and deliver them to the boss. Don't let other managers bump you or you'll lose the draft!</p>
    <button id="msg-btn" onclick="startGame()" class="w-full bg-blue-600 p-4 rounded-xl font-bold text-lg">START GAME</button>
</div>

<div class="touch-controls">
    <div class="flex gap-4">
        <div class="t-btn" id="btn-left">←</div>
        <div class="t-btn" id="btn-right">→</div>
    </div>
    <div class="t-btn" id="btn-jump">↑</div>
</div>

<canvas id="gameCanvas"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, getDocs, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let user = null;

    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Auth error:", error);
        }
    };
    initAuth();

    onAuthStateChanged(auth, (u) => {
        user = u;
        if (user) {
            recordVisit();
            syncStats();
        }
    });

    async function recordVisit() {
        if (!user) return;
        const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile');
        const userDoc = await getDoc(userRef);
        
        if (!userDoc.exists()) {
            await setDoc(userRef, { visitedAt: new Date(), highscore: 0 });
            const globalRef = doc(db, 'artifacts', appId, 'public', 'data', 'counters');
            try {
                await updateDoc(globalRef, { total_players: increment(1) });
            } catch (e) {
                await setDoc(globalRef, { total_players: 1 }, { merge: true });
            }
        }
    }

    function syncStats() {
        if (!user) return;
        onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'counters'), (docSnap) => {
            if (docSnap.exists()) {
                document.getElementById('stat-total-players').innerText = docSnap.data().total_players || 0;
            }
        });
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), (querySnapshot) => {
            const scores = [];
            querySnapshot.forEach((doc) => scores.push(doc.data()));
            scores.sort((a, b) => b.score - a.score);
            const listEl = document.getElementById('leaderboard-list');
            if (scores.length === 0) {
                listEl.innerHTML = `<div class="text-center text-gray-400 py-2 italic text-[10px]">No scores yet.</div>`;
                return;
            }
            listEl.innerHTML = scores.slice(0, 3).map((s, i) => `
                <div class="leaderboard-item">
                    <span class="text-blue-200">#${i+1} ${s.userId.substring(0, 6)}...</span>
                    <span class="font-bold text-yellow-400">${s.score} pts</span>
                </div>
            `).join('');
        });
    }

    window.saveGameScore = async (score) => {
        if (!user) return;
        const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile');
        const userSnap = await getDoc(userRef);
        const currentBest = userSnap.exists() ? (userSnap.data().highscore || 0) : 0;
        if (score > currentBest) {
            await updateDoc(userRef, { highscore: score });
            const leaderRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', user.uid);
            await setDoc(leaderRef, { userId: user.uid, score: score, updatedAt: new Date() });
        }
    };
</script>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const quizModal = document.getElementById('quiz-modal');
const msgModal = document.getElementById('msg-modal');

let gameState = 'START';
let delivered = 0;
let totalPoints = 0;
let energy = 100;
let hasResume = false;
let currentQuizIndex = 0;
let currentDay = 1;
let managerSpeedMult = 1.0;
let correctCount = 0;

const GRAVITY = 0.55;
const FRICTION = 0.82;
const WORLD_HEIGHT = 2000;

const player = {
    x: 0, y: 0, w: 24, h: 56, vx: 0, vy: 0,
    speed: 5.8, jump: -14, grounded: false,
    facing: 1, legAngle: 0, isWalking: false, invuln: 0 
};

const camera = { y: 0, targetY: 0 };
let platforms = [];
let coffeeCups = [];
let managers = [];
let targetManagerIndex = -1;

const masterQuestionPool = [
    { q: "What is the primary purpose of a resume?", a: ["To get a job interview", "To list every hobby", "To show off a photo"], c: 0, f: "A resume's main goal is to secure an interview!" },
    { q: "Standard student resume length?", a: ["One page", "Three pages", "As long as possible"], c: 0, f: "One page is standard for students." },
    { q: "Which is a 'Contact Information' essential?", a: ["Phone number", "Favorite color", "Height"], c: 0, f: "Employers need a way to reach you." },
    { q: "Best font size for body text?", a: ["10-12 point", "24 point", "8 point"], c: 0, f: "10-12pt is professional and readable." },
    { q: "Section for school and grad date?", a: ["Education", "Hobbies", "References"], c: 0, f: "Education shows your academic background." },
    { q: "What is a 'Hard Skill'?", a: ["Typing 60 wpm", "Being nice", "Good attitude"], c: 0, f: "Hard skills are specific, teachable abilities." },
    { q: "What is a 'Soft Skill'?", a: ["Teamwork", "Forklift driving", "Spanish speaking"], c: 0, f: "Soft skills are personal traits like teamwork." },
    { q: "Why use 'Action Verbs'?", a: ["To sound energetic", "To fill space", "Because they're long"], c: 0, f: "Action verbs make accomplishments sound stronger." },
    { q: "Include birthdate on a resume?", a: ["No", "Yes", "Only on holidays"], c: 0, f: "Avoid personal info to prevent bias." },
    { q: "What is 'Reverse-Chronological'?", a: ["Newest to oldest", "Oldest to newest", "Alphabetical"], c: 0, f: "Standard is listing your newest experience first." },
    { q: "Professional email example?", a: ["first.last@email.com", "gamer123@email.com", "pizza@email.com"], c: 0, f: "Use a simple name-based email." },
    { q: "What is a 'Reference'?", a: ["Voucher for your work", "A book you like", "A website link"], c: 0, f: "References vouch for your professional character." },
    { q: "Check for spelling errors?", a: ["Yes, always", "No", "Only if time permits"], c: 0, f: "Typos look very unprofessional." },
    { q: "What is a 'Summary'?", a: ["Short intro of goals", "List of pets", "Longest section"], c: 0, f: "A summary is a quick pitch at the top." },
    { q: "A good section heading?", a: ["Work Experience", "Stuff I Did", "Money Makers"], c: 0, f: "Standard headings are easier to scan." },
    { q: "What is 'White Space'?", a: ["Empty areas", "White ink", "Erasing"], c: 0, f: "White space improves readability." },
    { q: "Should you lie?", a: ["Never", "Small things", "To get the job"], c: 0, f: "Lying can get you fired instantly." },
    { q: "What is an 'Internship'?", a: ["Learning job", "Type of school", "Sports team"], c: 0, f: "Internships provide real-world experience." },
    { q: "No experience? List this:", a: ["Volunteer/Clubs", "Nothing", "Movies"], c: 0, f: "Volunteering proves a work ethic." },
    { q: "Best file format?", a: ["PDF", "Text", "Photo"], c: 0, f: "PDF preserves your formatting." },
    { q: "Example of an action verb?", a: ["Organized", "Happy", "Fast"], c: 0, f: "Organized is a clear action." },
    { q: "What is 'Tailoring'?", a: ["Matching the job", "Smaller size", "Cloth printing"], c: 0, f: "Match skills to what the employer wants." },
    { q: "Use a template?", a: ["Yes, if clean", "Never", "Only if paid"], c: 0, f: "Templates ensure a clean layout." },
    { q: "What is a 'Bullet Point'?", a: ["Short itemized line", "Punctuation", "Drawing"], c: 0, f: "Bullets make scanning much faster." },
    { q: "Include references on resume?", a: ["Usually no", "Always", "At the bottom"], c: 0, f: "Keep them separate unless asked." },
    { q: "Transferable skill?", a: ["Leadership", "Secret keeping", "Eating fast"], c: 0, f: "Leadership works in any job." },
    { q: "Social media links?", a: ["Only if professional", "Always", "Never"], c: 0, f: "Only link LinkedIn or portfolios." },
    { q: "Describe duties as...", a: ["Accomplishments", "A schedule", "Effort"], c: 0, f: "Focus on results, not just tasks." },
    { q: "Volunteer work benefit?", a: ["Builds experience", "Paid hobby", "School work"], c: 0, f: "Volunteering builds early skills." },
    { q: "List babysitting?", a: ["Yes, shows responsibility", "No", "Only if paid high"], c: 0, f: "Babysitting shows trustworthiness." },
    { q: "Professional font style?", a: ["Sans-serif (Arial)", "Cursive", "3D Fancy"], c: 0, f: "Clean fonts are best." },
    { q: "What is a 'Header'?", a: ["Name section", "Company title", "Hat type"], c: 0, f: "The header identifies you." },
    { q: "Use 'I' or 'Me'?", a: ["Avoid them", "Always", "In Objective"], c: 0, f: "Use fragments like 'Led team' instead." },
    { q: "What is 'GPA'?", a: ["Grade Point Average", "Personal Ability", "Professional Asset"], c: 0, f: "Include if it's 3.5 or higher." },
    { q: "Is Punctuality a skill?", a: ["Yes, critical", "No", "Only for clocks"], c: 0, f: "Being on time is a vital soft skill." },
    { q: "What is 'Keywords'?", a: ["Job description terms", "Secret codes", "Password"], c: 0, f: "Use terms from the job ad to pass filters." },
    { q: "An 'ATS' is a...", a: ["Resume scanning system", "Type of car", "Job title"], c: 0, f: "Applicant Tracking Systems scan resumes." },
    { q: "Include High School after College?", a: ["Usually remove it", "Always keep", "List first"], c: 0, f: "Once in college, HS info is less relevant." },
    { q: "Should margins be even?", a: ["Yes, for balance", "No", "Only on top"], c: 0, f: "Balanced margins look professional." },
    { q: "Bold text use?", a: ["Highlight key info", "Every word", "Only name"], c: 0, f: "Use bold to draw eyes to titles." },
    { q: "Quantify results means?", a: ["Using numbers", "Using adjectives", "Using color"], c: 0, f: "Numbers (like 'Saved 20%') prove impact." },
    { q: "Gaps in work history?", a: ["Explain honestly", "Hide them", "Make up jobs"], c: 0, f: "Be honest about gaps if asked." },
    { q: "Professional summary length?", a: ["3-5 lines", "2 pages", "One word"], c: 0, f: "Keep the summary concise." },
    { q: "Include salary history?", a: ["No, wait for offer", "Yes, always", "In the header"], c: 0, f: "Discuss salary later in the process." },
    { q: "Personal interests inclusion?", a: ["If they show character", "Every interest", "Never"], c: 0, f: "Interests like 'Marathon runner' show discipline." },
    { q: "Functional Resume focuses on:", a: ["Skills", "Dates", "Company names"], c: 0, f: "Functional resumes emphasize skill sets." },
    { q: "Resume paper color?", a: ["White or Off-white", "Neon green", "Black"], c: 0, f: "Keep it simple and classic." },
    { q: "Include 'References available'?", a: ["Not necessary anymore", "Mandatory", "In bold"], c: 0, f: "It's assumed you have them." },
    { q: "What is a 'Cover Letter'?", a: ["A tailored intro", "A resume copy", "A thank you note"], c: 0, f: "It introduces you to the hiring manager." },
    { q: "Keywords placement?", a: ["Throughout the text", "Only at bottom", "In the header"], c: 0, f: "Integrate keywords naturally." },
    { q: "Should you use slang?", a: ["Never", "To sound cool", "If friends work there"], c: 0, f: "Maintain a professional tone." },
    { q: "Mention your age?", a: ["No", "Yes", "Only if young"], c: 0, f: "Age is not relevant to performance." },
    { q: "List basic computer skills?", a: ["Yes, like MS Office", "Only if coder", "No"], c: 0, f: "Most jobs require basic digital literacy." }
];

let remainingQuestions = [];

function getNextQuestions(count) {
    if (remainingQuestions.length < count) {
        remainingQuestions = [...masterQuestionPool].sort(() => 0.5 - Math.random());
    }
    return remainingQuestions.splice(0, count);
}

const centerStation = { x: 0, y: 0, w: 120, h: 50 };
const keys = {};

function initLevel() {
    const scale = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * scale;
    canvas.height = window.innerHeight * scale;
    canvas.style.width = window.innerWidth + 'px';
    canvas.style.height = window.innerHeight + 'px';
    ctx.scale(scale, scale);
    player.x = window.innerWidth / 2 - 12;
    player.y = WORLD_HEIGHT - 120;
    camera.y = WORLD_HEIGHT - window.innerHeight;
    platforms = [{ x: 0, y: WORLD_HEIGHT - 40, w: window.innerWidth, h: 100 }];
    const floorHeight = 180;
    for(let i = 1; i < 11; i++) {
        const y = WORLD_HEIGHT - 40 - (i * floorHeight);
        const pW = window.innerWidth * 0.55;
        if (i % 2 === 0) {
            platforms.push({ x: 0, y: y, w: pW, h: 25, floorId: i });
            platforms.push({ x: window.innerWidth - pW * 0.3, y: y - 50, w: pW * 0.3, h: 25 });
        } else {
            platforms.push({ x: window.innerWidth - pW, y: y, w: pW, h: 25, floorId: i });
            platforms.push({ x: 0, y: y - 50, w: pW * 0.3, h: 25 });
        }
    }
    centerStation.x = window.innerWidth / 2 - 60;
    centerStation.y = WORLD_HEIGHT - 110;
    spawnAssets();
}

function spawnAssets() {
    coffeeCups = []; managers = [];
    for(let i = 1; i < 11; i++) {
        const p = platforms.find(pl => pl.floorId === i);
        if(p) {
            coffeeCups.push({ x: p.x + 20, y: p.y - 30, w: 18, h: 22, active: true });
            managers.push({
                x: p.x + p.w / 2, y: p.y - 60, w: 30, h: 60,
                gender: Math.random() > 0.5 ? 'f' : 'm',
                active: true, isPatrol: true,
                patrolRange: { min: p.x + 5, max: p.x + p.w - 35 },
                patrolDir: 1, patrolSpeed: (1.2 + (Math.random() * 0.5)) * managerSpeedMult, 
                legAngle: 0
            });
        }
    }
    targetManagerIndex = Math.floor(Math.random() * managers.length);
}

const handleInput = (key, state) => keys[key] = state;
const bind = (id, key) => {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', e => { e.preventDefault(); handleInput(key, true); }, {passive: false});
    el.addEventListener('touchend', e => { e.preventDefault(); handleInput(key, false); }, {passive: false});
};
bind('btn-left', 'ArrowLeft'); bind('btn-right', 'ArrowRight'); bind('btn-jump', 'Space');
window.addEventListener('keydown', e => handleInput(e.code, true));
window.addEventListener('keyup', e => handleInput(e.code, false));

function startGame() {
    gameState = 'PLAYING'; delivered = 0; energy = 100; hasResume = false;
    msgModal.style.display = 'none';
    document.getElementById('delivered-count').innerText = "0";
    initLevel(); loop();
}

function loop() {
    if(gameState !== 'PLAYING') return;
    player.isWalking = false;
    if (keys['ArrowLeft']) { player.vx = -player.speed; player.facing = -1; player.isWalking = true; }
    else if (keys['ArrowRight']) { player.vx = player.speed; player.facing = 1; player.isWalking = true; }
    else player.vx *= FRICTION;
    if (keys['Space'] && player.grounded) { player.vy = player.jump; player.grounded = false; }
    player.vy += GRAVITY; player.x += player.vx; player.y += player.vy;
    if(player.isWalking) player.legAngle += 0.22;
    if(player.invuln > 0) player.invuln--;
    player.x = Math.max(0, Math.min(player.x, window.innerWidth - player.w));
    if(player.y + player.h > WORLD_HEIGHT) { player.y = WORLD_HEIGHT - player.h; player.vy = 0; player.grounded = true; }
    player.grounded = false;
    platforms.forEach(p => {
        if(player.vy >= 0) {
            if (player.x + player.w > p.x && player.x < p.x + p.w) {
                const playerBottom = player.y + player.h;
                const prevBottom = playerBottom - player.vy;
                if (playerBottom >= p.y && prevBottom <= p.y + 10) {
                    player.y = p.y - player.h; player.vy = 0; player.grounded = true;
                }
            }
        }
    });
    camera.targetY = player.y - window.innerHeight / 2;
    camera.y += (camera.targetY - camera.y) * 0.1;
    camera.y = Math.max(0, Math.min(camera.y, WORLD_HEIGHT - window.innerHeight));
    if(!hasResume && player.x < centerStation.x + centerStation.w && player.x + player.w > centerStation.x &&
       player.y < centerStation.y + centerStation.h && player.y + player.h > centerStation.y) {
        hasResume = true; document.getElementById('status-msg').innerText = "Deliver Now!";
    }
    managers.forEach((m, idx) => {
        const isTarget = idx === targetManagerIndex;
        if(m.isPatrol && !isTarget) {
            m.x += m.patrolDir * m.patrolSpeed; m.legAngle += 0.12;
            if(m.x < m.patrolRange.min || m.x > m.patrolRange.max) m.patrolDir *= -1;
        }
        if(player.x < m.x + m.w && player.x + player.w > m.x && player.y < m.y + m.h && player.y + player.h > m.y) {
            if (hasResume && isTarget) {
                hasResume = false; delivered++; totalPoints += 50; player.invuln = 60;
                targetManagerIndex = Math.floor(Math.random() * managers.length);
                document.getElementById('delivered-count').innerText = delivered;
                document.getElementById('total-points').innerText = totalPoints;
                document.getElementById('status-msg').innerText = "Nice Shot!";
            } else if (!isTarget && player.invuln === 0 && hasResume) {
                // If player has a resume, they get bumped
                hasResume = false; 
                document.getElementById('status-msg').innerText = "Dropped it!";
                player.vx = player.x < m.x ? -12 : 12; 
                player.vy = -8; 
                player.invuln = 45; 
                player.grounded = false;
            }
            // If hasResume is false, no bump happens (manager is ignored)
        }
    });
    coffeeCups.forEach(c => {
        if(c.active && player.x < c.x + c.w && player.x + player.w > c.x && player.y < c.y + c.h && player.y + player.h > c.y) {
            c.active = false; energy = Math.min(100, energy + 25);
            setTimeout(() => c.active = true, 5000);
        }
    });
    energy -= 0.07;
    document.getElementById('energy-bar').style.width = energy + "%";
    if(energy <= 0) endGame("OUT OF COFFEE");
    if(delivered >= 5) startQuiz();
    draw(); requestAnimationFrame(loop);
}

function drawHuman(x, y, w, h, type, facing, legAngle) {
    const sY = y - camera.y; const isF = type === 'f'; const isPlayer = type === 'player';
    const charW = isF ? w * 0.75 : w; const charX = x + (w - charW) / 2; const legSwing = Math.sin(legAngle) * 6;
    ctx.fillStyle = '#fbd38d'; ctx.fillRect(charX + charW/2 - 6, sY, 12, 12);
    ctx.fillStyle = isPlayer ? '#1a202c' : '#4a5568';
    if(isF) { ctx.fillRect(charX + charW/2 - 8, sY, 16, 4); ctx.fillRect(charX + charW/2 - 8, sY, 3, 14); ctx.fillRect(charX + charW/2 + 5, sY, 3, 14); }
    else { ctx.fillRect(charX + charW/2 - 6, sY, 12, 3); }
    ctx.fillStyle = isPlayer ? '#1a202c' : '#2d3748';
    if(isF) {
        ctx.beginPath(); ctx.moveTo(charX + 4, sY + 12); ctx.lineTo(charX + charW - 4, sY + 12);
        ctx.lineTo(charX + charW, sY + 38); ctx.lineTo(charX, sY + 38); ctx.closePath(); ctx.fill();
        ctx.fillStyle = '#fbd38d'; ctx.fillRect(charX + 4, sY + 38, 3, 16 + legSwing); ctx.fillRect(charX + charW - 7, sY + 38, 3, 16 - legSwing);
    } else {
        ctx.fillRect(charX + 3, sY + 12, charW - 6, 26);
        ctx.fillRect(charX + 4, sY + 38, 6, 18 + legSwing); ctx.fillRect(charX + charW - 10, sY + 38, 6, 18 - legSwing);
    }
    ctx.fillStyle = 'white'; ctx.fillRect(charX + charW/2 - 3, sY + 12, 6, 8);
    ctx.fillStyle = isPlayer ? '#3182ce' : '#e53e3e';
    ctx.beginPath(); ctx.moveTo(charX + charW/2, sY + 13); ctx.lineTo(charX + charW/2 + 2, sY + 18);
    ctx.lineTo(charX + charW/2, sY + 24); ctx.lineTo(charX + charW/2 - 2, sY + 18); ctx.fill();
}

function drawCoffee(c) {
    const sY = c.y - camera.y; ctx.fillStyle = 'white';
    ctx.beginPath(); ctx.moveTo(c.x, sY); ctx.lineTo(c.x + c.w, sY); ctx.lineTo(c.x + c.w - 3, sY + c.h); ctx.lineTo(c.x + 3, sY + c.h);
    ctx.closePath(); ctx.fill(); ctx.fillStyle = '#b7791f'; ctx.fillRect(c.x + 1, sY + 8, c.w - 2, 7);
    ctx.fillStyle = '#2d3748'; ctx.fillRect(c.x - 1, sY - 2, c.w + 2, 3);
}

function draw() {
    ctx.fillStyle = '#1e293b'; ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
    platforms.forEach(p => {
        ctx.fillStyle = '#4a5568'; ctx.fillRect(p.x, p.y - camera.y, p.w, p.h);
        ctx.fillStyle = '#2d3748'; ctx.fillRect(p.x, p.y - camera.y, p.w, 4);
    });

    const sY = centerStation.y - camera.y;
    ctx.fillStyle = '#795548'; ctx.fillRect(centerStation.x, sY + 30, centerStation.w, 20);
    ctx.fillRect(centerStation.x + 5, sY + 45, 5, 15); ctx.fillRect(centerStation.x + centerStation.w - 10, sY + 45, 5, 15);
    ctx.fillStyle = '#333'; ctx.fillRect(centerStation.x + 35, sY + 5, 50, 25);
    ctx.fillStyle = '#4dd0e1'; ctx.fillRect(centerStation.x + 38, sY + 8, 44, 19);
    ctx.fillStyle = '#222'; ctx.fillRect(centerStation.x + 55, sY + 25, 10, 8);
    ctx.fillStyle = '#999'; ctx.fillRect(centerStation.x + 90, sY + 18, 25, 12);
    ctx.fillStyle = 'white'; ctx.fillRect(centerStation.x + 93, sY + 22, 19, 4);
    ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center'; ctx.fillText("WRITE", centerStation.x + centerStation.w/2, sY - 5);

    coffeeCups.forEach(c => { if(c.active) drawCoffee(c); });
    managers.forEach((m, idx) => {
        const isT = idx === targetManagerIndex;
        if(isT && hasResume) {
            ctx.strokeStyle = 'gold'; ctx.lineWidth = 4;
            ctx.strokeRect(m.x - 5, m.y - camera.y - 5, m.w + 10, m.h + 10);
            ctx.fillStyle = 'gold'; ctx.fillText("BOSS", m.x + m.w/2, m.y - camera.y - 15);
        }
        drawHuman(m.x, m.y, m.w, m.h, m.gender, 1, m.legAngle);
    });
    if(player.invuln % 4 < 2) drawHuman(player.x, player.y, player.w, player.h, 'player', player.facing, player.legAngle);
    if(hasResume) { ctx.fillStyle = 'white'; ctx.fillRect(player.x + (player.facing === 1 ? 25 : -10), player.y - camera.y + 20, 10, 14); }
}

function startQuiz() {
    gameState = 'QUIZ'; sessionQuestions = getNextQuestions(5);
    currentQuizIndex = 0; correctCount = 0; quizModal.style.display = 'block'; renderQuestion();
}

function renderQuestion() {
    const q = sessionQuestions[currentQuizIndex];
    document.getElementById('q-num').innerText = currentQuizIndex + 1;
    document.getElementById('q-score').innerText = correctCount;
    document.getElementById('quiz-question').innerText = q.q;
    document.getElementById('quiz-feedback').classList.add('hidden');
    document.getElementById('next-q-btn').classList.add('hidden');
    
    // Randomize option order
    const indices = q.a.map((_, i) => i).sort(() => Math.random() - 0.5);
    
    const optCont = document.getElementById('quiz-options'); optCont.innerHTML = '';
    indices.forEach((origIdx) => {
        const b = document.createElement('button'); 
        b.className = 'btn-option'; 
        b.innerText = q.a[origIdx];
        
        b.onclick = () => {
            if (document.getElementById('next-q-btn').classList.contains('hidden')) {
                const feedback = document.getElementById('quiz-feedback');
                feedback.classList.remove('hidden'); feedback.innerText = q.f;
                
                if(origIdx === q.c) {
                    correctCount++; b.classList.add('correct');
                    feedback.className = "mt-3 p-3 rounded-lg text-sm font-medium bg-green-900/50 text-green-300";
                } else {
                    b.classList.add('wrong');
                    feedback.className = "mt-3 p-3 rounded-lg text-sm font-medium bg-red-900/50 text-red-300";
                    // Find and highlight correct answer
                    Array.from(optCont.children).forEach((btn, i) => {
                       if (indices[i] === q.c) btn.classList.add('correct');
                    });
                }
                document.getElementById('next-q-btn').classList.remove('hidden');
            }
        };
        optCont.appendChild(b);
    });
}

document.getElementById('next-q-btn').onclick = () => {
    currentQuizIndex++;
    if (currentQuizIndex >= sessionQuestions.length) {
        if (correctCount >= 3) { completeDay(); } 
        else { alert(`You got ${correctCount}/5. You need 3/5 to pass. Retrying floor...`); startQuiz(); }
    } else { renderQuestion(); }
};

function completeDay() {
    quizModal.style.display = 'none'; gameState = 'START'; currentDay++; managerSpeedMult += 0.2;
    if(window.saveGameScore) window.saveGameScore(totalPoints);
    msgModal.style.display = 'block';
    document.getElementById('msg-title').innerText = "DAY " + (currentDay-1) + " COMPLETE!";
    document.getElementById('msg-body').innerText = `Passed with ${correctCount}/5 correct! Ready for Day ${currentDay}? Managers are faster!`;
    document.getElementById('msg-btn').innerText = "START DAY " + currentDay;
    document.getElementById('game-day').innerText = currentDay;
}

function endGame(reason) {
    gameState = 'GAMEOVER'; if(window.saveGameScore) window.saveGameScore(totalPoints);
    msgModal.style.display = 'block';
    msgModal.innerHTML = `<h1 class='text-xl font-bold text-red-500'>${reason}</h1><button onclick='location.reload()' class='bg-blue-600 p-3 rounded mt-4 w-full'>RETRY</button>`;
}

window.addEventListener('resize', initLevel);
initLevel();
</script>
</body>
</html>
